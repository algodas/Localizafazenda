
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Localizar fazendas: ( Com Bioma vinculado a cacau, que possua malhas de √°gua a menos de 3KM e com rodovias a menos de 6KM</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f2f2f2;
    }
    header {
      background-color: #4CAF50;
      color: white;
      padding: 16px;
      font-size: 20px;
    }
    .container {
      padding: 20px;
      max-width: 960px;
      margin: auto;
    }
    iframe {
      width: 100%;
      height: 500px;
      border: 2px solid #ddd;
      border-radius: 8px;
      margin-bottom: 30px;
    }
    h2 {
      color: #333;
    }
    input[type="file"], button {
      display: block;
      margin: 10px 0;
      padding: 10px;
      font-size: 14px;
    }
    ul {
      line-height: 1.6;
      list-style: none;
      padding-left: 0;
    }
    li a {
      text-decoration: none;
      color: #1a73e8;
    }
    li a:hover {
      text-decoration: underline;
    }
    .map-link {
      margin-top: 20px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <header>
    üìç Localizar fazendas: (Com Bioma vinculado a cacau, que possua malhas de √°gua a menos de 3KM e com rodovias a menos de 6KM)
  </header>

  <div class="container">
    <div style="background: #fff; border-left: 4px solid #4CAF50; padding: 10px 20px; margin-bottom: 20px;">
      <strong>Para facilitar o entendimento, o processo foi dividido em duas fases:</strong>
    </div>

    <div style="background: #fff; border-left: 4px solid #4CAF50; padding: 10px 20px; margin-bottom: 20px;">
      <strong>Fase 1:</strong> Identifica√ß√£o de regi√µes com alta probabilidade de cultivo de cacau a partir de dados do MapBiomas e an√°lise de NDVI, EVI e NDWI usando imagens Sentinel-2. Foram cruzadas essas regi√µes com √°reas com presen√ßa de √°gua (com base no NDWI e JRC) e exportados os pontos que satisfaziam a condi√ß√£o de estarem a at√© 3 km de fontes h√≠dricas.
    </div>

    <iframe src="https://bubbly-tractor-348100.projects.earthengine.app/view/localizafazenda" allowfullscreen></iframe>

    <div style="background: #fff; border-left: 4px solid #4CAF50; padding: 10px 20px; margin-bottom: 20px;">
      <strong>Fase 2:</strong> A partir das coordenadas exportadas (√°gua + cacau), realiza-se aqui a verifica√ß√£o de quais desses pontos est√£o tamb√©m pr√≥ximos a rodovias (em at√© 5 km), usando um algoritmo de verifica√ß√£o geod√©sica e expans√£o geogr√°fica no HTML.
    </div>

    <h2>üõ£Ô∏è Regi√µes prop√≠cias ao cultivo de Cacau e que estejam pr√≥ximas de √Ågua e Rodovias</h2>
    <input type="file" id="fileInput" accept=".csv">
    <button onclick="processarCSV()">üì• Processar Arquivo</button>
    <div id="output"></div>
  </div>

  <script>
    const apiKey = "";

    function geodesicDistance(lat1, lon1, lat2, lon2) {
      const toRad = deg => deg * Math.PI / 180;
      const R = 6371;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat / 2) ** 2 +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon / 2) ** 2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    function parseCSV(text) {
      const lines = text.trim().split("\n");
      const headers = lines[0].split(",");
      return lines.slice(1).map(line => {
        const values = line.split(",");
        return Object.fromEntries(headers.map((h, i) => [h.trim(), values[i]?.trim() || ""]));
      });
    }

    async function estaProximoDeRodovia(lat, lon) {
      const delta = 0.045;
      const offsets = [0, -delta, delta];
      for (let dLat of offsets) {
        for (let dLon of offsets) {
          const newLat = lat + dLat;
          const newLon = lon + dLon;
          const url = `https://roads.googleapis.com/v1/nearestRoads?points=${newLat},${newLon}&key=${apiKey}`;
          try {
            const resp = await fetch(url);
            const data = await resp.json();
            if (data.snappedPoints && data.snappedPoints.length > 0) {
              return true;
            }
          } catch (err) {
            console.warn(`Erro na checagem ${newLat},${newLon}:`, err);
          }
        }
      }
      return false;
    }

    async function processarCSV() {
      
    const file = document.getElementById("fileInput").files[0];
    const outputDiv = document.getElementById("output");
    outputDiv.innerHTML = '<p>‚è≥ Processando arquivo, por favor aguarde...</p>';
    
      if (!file) return alert("Selecione um arquivo CSV primeiro.");
      const text = await file.text();
      const dados = parseCSV(text);
      const pontosValidos = [];

      for (const ponto of dados) {
        const lat = parseFloat(ponto.latitude);
        const lon = parseFloat(ponto.longitude);
        if (isNaN(lat) || isNaN(lon)) continue;

        const pertoRodovia = await estaProximoDeRodovia(lat, lon);
        if (pertoRodovia) {
          pontosValidos.push({ ...ponto, latitude: lat, longitude: lon });
        }
      }

      const coordsLinks = [];
      let ulHTML = '<ul>';
      for (const item of pontosValidos) {
        const lat = item.latitude.toFixed(6);
        const lon = item.longitude.toFixed(6);
        const link = `https://www.google.com/maps?q=${lat},${lon}`;
        coordsLinks.push(`${lat},${lon}`);
        ulHTML += `<li><a href="${link}" target="_blank">${lat}, ${lon}</a></li>`;
      }
      ulHTML += '</ul>';

      let linkMapaTodos = '';
      if (coordsLinks.length > 1) {
        const destino = coordsLinks[coordsLinks.length - 1];
        const waypoints = coordsLinks.slice(0, -1).join("|");
        const allMap = `https://www.google.com/maps/dir/?api=1&destination=${destino}&waypoints=${waypoints}`;
        linkMapaTodos = `<div class="map-link">üìå <a href="${allMap}" target="_blank">Ver todos os pontos no mapa</a></div>`;
      }

      document.getElementById("output").innerHTML = ulHTML + linkMapaTodos;
    }
  </script>
</body>
</html>
